<a href="https://nextjs.org">
  <h1 align="center">Onset Next.js Starter</h1>
</a>

<p align="center">
  An open source Next.js starter with step-by-step instructions if required.
</p>

<p align="center">
  <a href="https://twitter.com/nrjdalal_com">
    <img src="https://img.shields.io/twitter/follow/nrjdalal_com?style=flat&label=nrjdalal_com&logo=twitter&color=0bf&logoColor=fff" alt="Follow Neeraj on Twitter" />
  </a>
</p>

<p align="center">
  <a href="#features"><strong>Features</strong></a> ·
  <a href="#step-by-step"><strong>Step by Step</strong></a> ·
  <a href="#roadmap"><strong>Roadmap</strong></a> ·
  <a href="#author"><strong>Author</strong></a> ·
  <a href="#credits"><strong>Credits</strong></a>
</p>

Onset is a Next.js starter that comes with step-by-step instructions to understand how everything works, easy for both beginners and experts alike and giving you the confidence to customize it to your needs. Built with Next.js 14, Drizzle (Postgres), NextAuth/Auth.js.

<!-- About: An open source Next.js bare starter with step-by-step instructions if required. Built with Next.js 14, Drizzle (Postgres), NextAuth/Auth.js. -->
<!-- Keywords: drizzle neondb nextauthjs nextjs postgres shadcn tailwindcss typescript vercel -->

## Features

### Frameworks

- [Next.js](https://nextjs.org/) – React framework for building performant apps with the best developer experience
- [Auth.js](https://authjs.dev/) – Handle user authentication with ease with providers like Google, Twitter, GitHub, etc.
- [Drizzle](https://orm.drizzle.team/) – Typescript-first ORM for Node.js

### Platforms

- [Vercel](https://vercel.com/) – Easily preview & deploy changes with git
- [Neon](https://neon.tech/) – The fully managed serverless Postgres with a generous free tier

## Automatic Setup

### Installation

Clone & create this repo locally with the following command:

> Note: You can use `npx` or `pnpx` as well

```bash
bunx create-next-app onset-starter --example "https://github.com/nrjdalal/onset"
```

1. Install dependencies using pnpm:

```sh
bun install
```

2. Copy `.env.example` to `.env.local` and update the variables.

```sh
cp .env.example .env.local
```

3. Run the database migrations:

```sh
bun db:push
```

3. Start the development server:

```sh
bun dev
```

## Step by Step

> Hint: Using `bun` instead of `npm`/`pnpm` and `bunx` instead of `npx`/`pnpx`. You can use the latter if you want.

### Phase 1 (Initialization)

#### 1. Initialize the project

Refs:

- [Installation](https://nextjs.org/docs/getting-started/installation)

```sh
bunx create-next-app . --ts --eslint --tailwind --src-dir --app --import-alias "@/*"
```

#### 2. Install `prettier` and supporting plugins

Refs:

- [prettier-plugin-sort-imports](https://github.com/IanVS/prettier-plugin-sort-imports)
- [prettier](https://prettier.io/)
- [prettier-plugin-tailwindcss](https://github.com/tailwindlabs/prettier-plugin-tailwindcss)

```sh
bun add -D @ianvs/prettier-plugin-sort-imports prettier prettier-plugin-tailwindcss
```

#### 3. Create `prettier.config.js`

```js
/** @type {import('prettier').Config} */
module.exports = {
  semi: false,
  singleQuote: true,
  plugins: [
    '@ianvs/prettier-plugin-sort-imports',
    'prettier-plugin-tailwindcss',
  ],
}
```

#### 4. Create `src/lib/fonts.ts`

Refs:

- [Font Optimization](https://nextjs.org/docs/app/building-your-application/optimizing/fonts)

```ts
import {
  JetBrains_Mono as FontMono,
  DM_Sans as FontSans,
} from 'next/font/google'

export const fontMono = FontMono({
  subsets: ['latin'],
  variable: '--font-mono',
})

export const fontSans = FontSans({
  subsets: ['latin'],
  variable: '--font-sans',
})
```

#### 5. Install `clsx` and `tailwind-merge`

Refs:

- [clsx](https://github.com/lukeed/clsx)
- [tailwind-merge](https://github.com/dcastil/tailwind-merge)

```sh
bun add clsx tailwind-merge
```

#### 6. Create `src/lib/utils.ts`

```ts
import { clsx, type ClassValue } from 'clsx'
import { twMerge } from 'tailwind-merge'

export const cn = (...inputs: ClassValue[]) => {
  return twMerge(clsx(inputs))
}
```

#### 7. Update `src/app/layout.tsx`

```ts
import './globals.css'
import { fontMono, fontSans } from '@/lib/fonts'
import { cn } from '@/lib/utils'
import type { Metadata } from 'next'

export const metadata: Metadata = {
  title: 'Onset',
  description: 'Generated by create next app',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body
        className={cn(
          'min-h-[100dvh] font-sans antialiased',
          fontMono.variable,
          fontSans.variable,
        )}
      >
        {children}
      </body>
    </html>
  )
}
```

### Phase 2 (Database)

#### 1. Install `drizzle` and supporting packages

Refs:

- [Drizzle Postgres](https://orm.drizzle.team/docs/quick-postgresql/postgresjs)

```sh
bun add @auth/drizzle-adapter drizzle-orm pg postgres
bun add -D drizzle-kit
```

#### 2. Create `src/lib/db/schema.ts`

Refs:

- [Drizzle NextAuth Schema](https://authjs.dev/reference/adapter/drizzle)

```ts
import type { AdapterAccount } from '@auth/core/adapters'
import {
  integer,
  pgTable,
  primaryKey,
  text,
  timestamp,
} from 'drizzle-orm/pg-core'

export const users = pgTable('user', {
  id: text('id').notNull().primaryKey(),
  name: text('name'),
  email: text('email').notNull(),
  emailVerified: timestamp('emailVerified', { mode: 'date' }),
  image: text('image'),
})

export const accounts = pgTable(
  'account',
  {
    userId: text('userId')
      .notNull()
      .references(() => users.id, { onDelete: 'cascade' }),
    type: text('type').$type<AdapterAccount['type']>().notNull(),
    provider: text('provider').notNull(),
    providerAccountId: text('providerAccountId').notNull(),
    refresh_token: text('refresh_token'),
    access_token: text('access_token'),
    expires_at: integer('expires_at'),
    token_type: text('token_type'),
    scope: text('scope'),
    id_token: text('id_token'),
    session_state: text('session_state'),
  },
  (account) => ({
    compoundKey: primaryKey(account.provider, account.providerAccountId),
  }),
)

export const sessions = pgTable('session', {
  sessionToken: text('sessionToken').notNull().primaryKey(),
  userId: text('userId')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' }),
  expires: timestamp('expires', { mode: 'date' }).notNull(),
})

export const verificationTokens = pgTable(
  'verificationToken',
  {
    identifier: text('identifier').notNull(),
    token: text('token').notNull(),
    expires: timestamp('expires', { mode: 'date' }).notNull(),
  },
  (vt) => ({
    compoundKey: primaryKey(vt.identifier, vt.token),
  }),
)
```

#### 3. Create `src/lib/db/index.ts`

Refs:

- [Drizzle Kit](https://orm.drizzle.team/kit-docs/overview)

```ts
import { drizzle, PostgresJsDatabase } from 'drizzle-orm/postgres-js'
import postgres from 'postgres'

const queryClient = postgres(process.env.POSTGRES_URL as string)

export const db: PostgresJsDatabase = drizzle(queryClient)
```

#### 4. Create `drizzle.config.ts`

```ts
import type { Config } from 'drizzle-kit'

export default {
  schema: './src/lib/db/schema.ts',
  driver: 'pg',
  dbCredentials: {
    connectionString: process.env.POSTGRES_URL as string,
  },
} satisfies Config
```

#### 5. Copy `.env.example` as `.env.local`

> Hint: You can use [`pglaunch`](https://github.com/nrjdalal/pglaunch) to generate a postgres url

```env
POSTGRES_URL="**********"
```

#### 6. Update `package.json`

```json
{
  // ...
  "scripts": {
    // ...
    "db:push": "drizzle-kit push:pg --config drizzle.config.ts",
    "db:studio": "drizzle-kit studio --config drizzle.config.ts"
  }
  // ...
}
```

#### 7. Update `tsconfig.json`

```json
{
  "compilerOptions": {
    "target": "ESNext"
    // ...
  }
  // ...
}
```

##### 7. Run `db:push` to create tables

```sh
bun db:push
```

### Phase 3 (Authentication)

#### 1. Install `next-auth`

```sh
bun add next-auth
```

#### 2. Update `.env.local`

```env
# ...
NEXTAUTH_SECRET="**********"

GOOGLE_CLIENT_ID="**********"
GOOGLE_CLIENT_SECRET="**********"
```

3. Create `src/lib/auth.ts`

```ts
import { db } from '@/lib/db'
import { users } from '@/lib/db/schema'
import { DrizzleAdapter } from '@auth/drizzle-adapter'
import { eq } from 'drizzle-orm'
import { NextAuthOptions } from 'next-auth'
import type { User } from 'next-auth'
import GoogleProvider from 'next-auth/providers/google'

export const authOptions: NextAuthOptions = {
  adapter: DrizzleAdapter(db),
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID as string,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET as string,
    }),
  ],
  pages: {
    signIn: '/access',
  },
  session: {
    strategy: 'jwt',
  },
  callbacks: {
    async session({ token, session }) {
      if (token) {
        session.user.id = token.id
        session.user.name = token.name
        session.user.email = token.email
        session.user.image = token.picture
      }

      return session
    },
    async jwt({ token, user }) {
      const [dbUser] = await db
        .select()
        .from(users)
        .where(eq(users.email, token.email || ''))
        .limit(1)

      if (!dbUser) {
        if (user) {
          token.id = user?.id
        }
        return token
      }

      return {
        id: dbUser.id,
        name: dbUser.name,
        email: dbUser.email,
        picture: dbUser.image,
      }
    },
  },
}

declare module 'next-auth/jwt' {
  interface JWT {
    id: string
  }
}

declare module 'next-auth' {
  interface Session {
    user: User & {
      id: string
    }
  }
}
```

#### 3. Create `src/app/api/auth/[...nextauth]/route.ts`

```ts
import { authOptions } from '@/lib/auth'
import NextAuth from 'next-auth'

const handler = NextAuth(authOptions)

export { handler as GET, handler as POST }
```

#### 4. Create `src/middleware.ts`

```ts
import { getToken } from 'next-auth/jwt'
import { withAuth } from 'next-auth/middleware'
import { NextResponse } from 'next/server'

export default withAuth(
  async function middleware(req) {
    const token = await getToken({ req })

    const isAuth = !!token
    const isAuthPage = req.nextUrl.pathname.startsWith('/access')

    if (isAuthPage) {
      if (isAuth) {
        return NextResponse.redirect(new URL('/dashboard', req.url))
      }

      return null
    }

    if (!isAuth) {
      let from = req.nextUrl.pathname
      if (req.nextUrl.search) {
        from += req.nextUrl.search
      }

      return NextResponse.redirect(
        new URL(`/access?from=${encodeURIComponent(from)}`, req.url),
      )
    }
  },
  {
    callbacks: {
      async authorized() {
        return true
      },
    },
  },
)

export const config = {
  matcher: ['/access', '/dashboard/:path*'],
}
```

#### 5. Create `src/app/(auth)/access/page.tsx`

```tsx
'use client'

import { signIn } from 'next-auth/react'
import Link from 'next/link'

const Page = () => {
  return (
    <div className="flex min-h-[100dvh] items-center justify-center gap-4">
      <Link
        href={'/'}
        className="rounded-md bg-slate-900 px-8 py-2.5 text-white"
      >
        Home
      </Link>
      <button
        className="rounded-md border px-8 py-2.5"
        onClick={() => signIn('google')}
      >
        Continue with Google
      </button>
    </div>
  )
}

export default Page
```

#### 6. Create `src/app/(admin)/dashboard/page.tsx`

```tsx
'use client'

import { signOut } from 'next-auth/react'
import Link from 'next/link'

const Page = () => {
  return (
    <div className="flex min-h-[100dvh] items-center justify-center gap-4">
      <Link
        href={'/'}
        className="rounded-md bg-slate-900 px-8 py-2.5 text-white"
      >
        Home
      </Link>
      <button
        className="rounded-md border px-8 py-2.5"
        onClick={() => signOut()}
      >
        Sign Out
      </button>
    </div>
  )
}

export default Page
```

## Roadmap

- [ ] Light and dark mode
- [ ] To added fine-grained instructions
- [ ] More features and points to be added

## Author

Created by [@nrjdalal](https://twitter.com/nrjdalal_com) in 2023, released under the [MIT license](https://github.com/nrjdalal/onset/blob/main/LICENSE.md).

## Credits

This project is inspired by [@shadcn](https://twitter.com/shadcn)'s [Taxonomy](https://github.com/shadcn-ui/taxonomy).
